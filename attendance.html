<script>
    const studentName = localStorage.getItem('studentName');
    const studentSeatNumber = localStorage.getItem('studentSeatNumber');
    const studentGrade = localStorage.getItem('studentGrade');

    if (studentName) {
        document.getElementById('seatNameDisplay').innerText = `자리번호: ${studentSeatNumber}`;
        document.getElementById('nameDisplay').innerText = `이름: ${studentName}`;
        document.getElementById('gradeDisplay').innerText = `학년: ${studentGrade}`;
    } else {
        window.location.href = 'index.html';
    }

    // 날짜 선택기에서 선택한 날짜 형식을 요일(3글자) 날짜로 변환
    let selectedDate = ''; // 선택된 날짜 저장
    let selectedWeekday = ''; // 선택된 요일 저장
    document.getElementById('date-picker').addEventListener('change', function(event) {
        selectedDate = event.target.value; // 선택한 날짜 (yyyy-mm-dd 형식)
        selectedWeekday = getWeekday(selectedDate); // 요일 계산
        const formattedDate = formatDate(selectedDate); // mm-dd 형식
        document.getElementById('selected-date').innerText = `${selectedWeekday} ${formattedDate}`; // 요일과 날짜 형식으로 표시
        fetchAttendanceData(); // 날짜 변경 시 출결 데이터를 다시 가져옴
    });

    function formatDate(dateString) {
        const date = new Date(dateString);
        const month = String(date.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 1을 더함
        const day = String(date.getDate()).padStart(2, '0');
        return `${month}-${day}`; // mm-dd 형식
    }

    function getWeekday(dateString) {
        const date = new Date(dateString);
        const weekdays = ["일", "월", "화", "수", "목", "금", "토"]; // 요일 배열
        return weekdays[date.getDay()]; // getDay()는 0(일요일)부터 6(토요일)까지 반환
    }

    // 출결 데이터 가져오기
    async function fetchAttendanceData() {
        const sheetId = '199CxKW0EHGTVHMwDIEmNJ5LsOcPxyFUtQv52osl7jTY';
        const sheetName = '출결';
        const apiKey = 'AIzaSyDeS-WjQLmzG7yw1_GWu5Tw3HwFxG5hYbk';
        const range = '출결!A:S'; // A열부터 S열까지 데이터 가져오기
        
        // Google Sheets API로 데이터 가져오기
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`);
        const data = await response.json();
        
        if (data.values && data.values.length > 0) {
            const tableBody = document.querySelector('#attendance-table tbody');
            tableBody.innerHTML = ''; // 테이블 초기화 (새로운 데이터 로드 시)
            
            // 출결 데이터 순회
            data.values.forEach((row, rowIndex) => {
                const seatNumber = row[0]; // 자리번호 (A열)
                const name = row[1]; // 이름 (B열)

                // 선택한 날짜의 열 인덱스 (요일별 열 번호 설정: 예시로 G, I, K, M, O, Q, S열)
                const dateColumns = {
                    '일': 6,
                    '월': 8,
                    '화': 10,
                    '수': 12,
                    '목': 14,
                    '금': 16,
                    '토': 18
                };

                const dateColumnIndex = dateColumns[selectedWeekday]; // 선택한 요일의 열 인덱스 가져오기
                const selectedCellValue = row[dateColumnIndex]; // 해당 날짜의 출결 정보

                // 자리번호, 이름, 요일에 맞는 데이터만 표시
                if (seatNumber === studentSeatNumber && name === studentName && selectedCellValue !== undefined) {
                    const tr = document.createElement('tr');
                    row.forEach((cell, index) => {
                        const td = document.createElement('td');

                        // 날짜에 해당하는 열 처리
                        if (index === dateColumnIndex) {
                            if (cell === '1') {
                                td.textContent = '출석';
                                td.classList.add('present'); // 출석일 경우 초록색 배경 추가
                            } else if (cell === '3') {
                                td.textContent = '결석';
                                td.classList.add('absent'); // 결석일 경우 빨간색 배경 추가
                            } else {
                                td.textContent = '기타';
                            }
                        } else {
                            td.textContent = cell;
                        }
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                }
            });
        }
    }

    fetchAttendanceData(); // 페이지 로드시 출결 데이터 가져오기

    // 햄버거 메뉴 기능
    document.getElementById('hamburger').addEventListener('click', () => {
        const mobileMenu = document.getElementById('mobile-menu');
        mobileMenu.classList.toggle('active');
    });

    // 로그아웃 버튼 클릭 시
    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.clear();
        window.location.href = 'index.html';
    });
</script>
