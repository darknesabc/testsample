<script>
    const studentName = localStorage.getItem('studentName');
    const studentSeatNumber = localStorage.getItem('studentSeatNumber');
    const studentGrade = localStorage.getItem('studentGrade');

    if (studentName) {
        document.getElementById('seatNameDisplay').innerText = `자리번호: ${studentSeatNumber}`;
        document.getElementById('nameDisplay').innerText = `이름: ${studentName}`;
        document.getElementById('gradeDisplay').innerText = `학년: ${studentGrade}`;
    } else {
        window.location.href = 'index.html';
    }

    // 날짜 선택기에서 선택한 날짜 형식을 mm-dd로 변환
    document.getElementById('date-picker').addEventListener('change', function(event) {
        const selectedDate = event.target.value; // 선택한 날짜 (yyyy-mm-dd 형식)
        const formattedDate = formatDate(selectedDate);
        console.log("선택한 날짜:", formattedDate); // mm-dd 형식 출력
        fetchAttendanceData(formattedDate); // 선택된 날짜에 따라 출결 데이터 가져오기
    });

    function formatDate(dateString) {
        const date = new Date(dateString);
        const month = String(date.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 1을 더함
        const day = String(date.getDate()).padStart(2, '0');
        return `${month}-${day}`; // mm-dd 형식
    }

    // 출결 데이터 가져오기
    async function fetchAttendanceData(selectedDate = '') {
        const sheetId = '199CxKW0EHGTVHMwDIEmNJ5LsOcPxyFUtQv52osl7jTY';
        const sheetName = '출결';
        const apiKey = 'AIzaSyDeS-WjQLmzG7yw1_GWu5Tw3HwFxG5hYbk';
        const range = '출결!A:S'; // A열부터 S열까지 데이터 가져오기
        
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`);
        const data = await response.json();

        if (data.values && data.values.length > 0) {
            const tableBody = document.querySelector('#attendance-table tbody');
            tableBody.innerHTML = ''; // 테이블 초기화

            data.values.forEach((row, rowIndex) => {
                const seatNumber = row[0]; // 자리번호 (A열)
                const name = row[1]; // 이름 (B열)

                // 자리번호와 이름이 매칭될 경우에만 표시
                if (seatNumber === studentSeatNumber && name === studentName) {
                    const tr = document.createElement('tr');
                    
                    row.forEach((cell, index) => {
                        const td = document.createElement('td');

                        // 날짜에 해당하는 열들 (요일 열도 포함)
                        if (selectedDate) {
                            const dateIndex = getDateColumnIndex(selectedDate); // 날짜에 해당하는 열 인덱스를 얻음
                            if (dateIndex === index) {
                                if (cell === '1') {
                                    td.textContent = '출석';
                                    td.classList.add('present'); // 출석일 경우 초록색 배경 추가
                                } else if (cell === '3') {
                                    td.textContent = '결석';
                                    td.classList.add('absent'); // 결석일 경우 빨간색 배경 추가
                                } else {
                                    td.textContent = cell;
                                }
                            }
                        } else {
                            // 날짜가 선택되지 않은 경우, 전체 데이터를 표시
                            if ([6, 8, 10, 12, 14, 16, 18].includes(index)) {
                                if (cell === '1') {
                                    td.textContent = '출석';
                                    td.classList.add('present'); // 출석일 경우 초록색 배경 추가
                                } else if (cell === '3') {
                                    td.textContent = '결석';
                                    td.classList.add('absent'); // 결석일 경우 빨간색 배경 추가
                                } else {
                                    td.textContent = cell;
                                }
                            } else {
                                td.textContent = cell;
                            }
                        }
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                }
            });
        }
    }

    // 날짜에 해당하는 열 인덱스를 반환하는 함수 (G, I, K, M, O, Q, S 열에 해당하는 인덱스)
    function getDateColumnIndex(date) {
        const dateMapping = {
            '01-01': 6, '01-02': 8, '01-03': 10, '01-04': 12, '01-05': 14, '01-06': 16, '01-07': 18,
            // 날짜에 맞는 인덱스를 매핑하세요.
            // 예: '01-01': 6, '01-02': 8 ...
        };

        return dateMapping[date] || null; // 날짜에 맞는 열을 반환
    }

    // 초기 호출 (날짜를 선택하지 않았을 경우)
    fetchAttendanceData();
</script>
